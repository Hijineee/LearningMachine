<?xml version="1.0" encoding="UTF-8" ?> <!-- 맵퍼파일 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="Payment">
  
  	<select id="paymentmain" parameterType="integer" resultType="map">
  		SELECT year(p_date)as year, MONTH(p_date) as month, sum(p_price2)as total FROM payment_lecture_view2 
  		where year(p_date) = #{year}
  		group by month(p_date)
 
  	</select>
  	
  	
  	<select id="circle" resultType="map">
		SELECT COUNT(*)AS COUNT, (SELECT l_category FROM lecture_category c WHERE c.l_code = v.l_code)AS 'category'
		FROM lecture_apply_user_view v
		GROUP BY category
  	</select>
  	
  

  	<select id="paymentList" parameterType="map" resultType="map">
  		select *,
  		
  		(select sum(p_price2) from payment_lecture_view2  
  		
  		<if test = "month != null"> 		
  		WHERE 
  		DATE(p_date) >= DATE_FORMAT(NOW(), '${year}-${month}-01')
		AND 
		<![CDATA[ 
		DATE(p_date) <= DATE('${year}-${month}-31')  
		]]>	
		</if>
		
		) as sumtotal ,
  		
  		(select sum(p_price2) from payment_lecture_view2 where p_refund = 1 
  		
  		<if test = "month != null">
  		AND
  		DATE(p_date) >= DATE_FORMAT(NOW(), '${year}-${month}-01')
		AND 
		<![CDATA[ 
		DATE(p_date) <= DATE('${year}-${month}-31')  
		]]>	
		</if>
		) as refundtotal
  		from payment_lecture_view2
  		<if test = "month != null">
  		WHERE 
  		DATE(p_date) >= DATE_FORMAT(NOW(), '${year}-${month}-01')
		AND 
		<![CDATA[ 
		DATE(p_date) <= DATE('${year}-${month}-31')  
		]]>	
		</if>
		<if test = "u_id != null">
  			where u_id = #{u_id}
  		</if>
  	</select>
  </mapper>